<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网易云音乐数据爬虫</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .container { max-width: 1200px; }
        .data-table { max-height: 500px; overflow-y: auto; }
        .stats-card { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .loading { display: none; text-align: center; margin: 20px; }
        .token-section { background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .data-section { display: none; }
        .chart-container { 
            background: white; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .charts-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); 
            gap: 20px; 
            margin: 20px 0; 
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">🎵 网易云音乐数据爬虫</h1>
        
        <!-- Token配置区域 -->
        <div class="token-section">
            <h3>🔑 配置访问凭证</h3>
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">CSRF Token:</label>
                    <input type="text" id="csrf_token" class="form-control" placeholder="输入最新的csrf_token">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Cookie:</label>
                    <textarea id="cookie" class="form-control" rows="3" placeholder="输入完整的cookie"></textarea>
                </div>
            </div>
            <div class="mt-3">
                <button class="btn btn-primary" onclick="updateToken()">更新Token</button>
                <button class="btn btn-success ms-2" onclick="fetchData()">获取数据</button>
            </div>
        </div>
        
        <!-- 状态显示 -->
        <div id="status" class="alert" style="display: none;"></div>
        
        <!-- 加载动画 -->
        <div class="loading" id="loading">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2">正在处理...</p>
        </div>
        
        <!-- 数据展示区域 -->
        <div class="data-section" id="dataSection">
            <!-- 统计信息 -->
            <div class="stats-card">
                <h4>📊 数据统计</h4>
                <div id="statsInfo"></div>
            </div>
            
            <!-- 下载选项 -->
            <div class="text-center mb-4">
                <h4>📥 下载数据</h4>
                <button class="btn btn-success me-2" onclick="downloadData('excel')">下载 Excel</button>
                <button class="btn btn-primary me-2" onclick="downloadData('csv')">下载 CSV</button>
                <button class="btn btn-warning" onclick="downloadData('json')">下载 JSON</button>
            </div>
            
            <!-- 可视化图表 -->
            <div id="chartsSection" style="display: none;">
                <h4>📊 数据可视化</h4>
                <div class="charts-grid" id="chartsContainer"></div>
            </div>
            
            <!-- 数据预览 -->
            <div>
                <h4>📋 数据预览</h4>
                <div class="data-table">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr id="tableHeader"></tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `alert alert-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            // 3秒后自动隐藏
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
        
        function showLoading(show = true) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        async function updateToken() {
            const csrf_token = document.getElementById('csrf_token').value.trim();
            const cookie = document.getElementById('cookie').value.trim();
            
            if (!csrf_token || !cookie) {
                showStatus('请填写完整的Token和Cookie信息', 'warning');
                return;
            }
            
            showLoading(true);
            
            try {
                const response = await fetch('/update_token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ csrf_token, cookie })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus(result.message, 'success');
                } else {
                    showStatus(result.message, 'danger');
                }
                
            } catch (error) {
                showStatus('更新Token时出错: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        async function fetchData() {
            showLoading(true);
            
            try {
                const response = await fetch('/fetch_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus(result.message, 'success');
                    displayData(result.data, result.stats);
                    if (result.charts) {
                        displayCharts(result.charts);
                    }
                    document.getElementById('dataSection').style.display = 'block';
                } else {
                    showStatus(result.message, 'danger');
                }
                
            } catch (error) {
                showStatus('获取数据时出错: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        function displayData(data, stats) {
            // 显示统计信息
            const statsDiv = document.getElementById('statsInfo');
            statsDiv.innerHTML = `
                <p><strong>歌曲总数:</strong> ${stats.total_songs}</p>
                <p><strong>数据列:</strong> ${stats.columns.join(', ')}</p>
            `;
            
            // 显示数据表格
            if (data && data.length > 0) {
                const headerRow = document.getElementById('tableHeader');
                const tableBody = document.getElementById('tableBody');
                
                // 清空现有内容
                headerRow.innerHTML = '';
                tableBody.innerHTML = '';
                
                // 创建表头
                const headers = Object.keys(data[0]);
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                
                // 创建表格行
                data.forEach(row => {
                    const tr = document.createElement('tr');
                    headers.forEach(header => {
                        const td = document.createElement('td');
                        td.textContent = row[header] || '';
                        tr.appendChild(td);
                    });
                    tableBody.appendChild(tr);
                });
            }
        }
        
        function displayCharts(charts) {
            const container = document.getElementById('chartsContainer');
            container.innerHTML = '';
            
            const chartTitles = {
                'top_songs': '🎵 热门歌曲排行',
                'numeric_comparison': '📊 数值字段分布对比',
                'scatter_plot': '🔗 关系图',
                'pie_chart': '📈 分布饼图',
                'avg_comparison': '📈 平均值对比'
            };
            
            let hasCharts = false;
            
            Object.keys(charts).forEach(chartKey => {
                if (charts[chartKey]) {
                    hasCharts = true;
                    const chartDiv = document.createElement('div');
                    chartDiv.className = 'chart-container';
                    
                    const chartId = `chart_${chartKey}`;
                    chartDiv.innerHTML = `
                        <h5>${chartTitles[chartKey] || chartKey}</h5>
                        <div id="${chartId}"></div>
                    `;
                    
                    container.appendChild(chartDiv);
                    
                    try {
                        const plotData = JSON.parse(charts[chartKey]);
                        Plotly.newPlot(chartId, plotData.data, plotData.layout, {
                            responsive: true,
                            displayModeBar: true
                        });
                    } catch (e) {
                        console.error('渲染图表时出错:', e);
                        chartDiv.innerHTML = `<p class="text-danger">图表渲染失败: ${e.message}</p>`;
                    }
                }
            });
            
            if (hasCharts) {
                document.getElementById('chartsSection').style.display = 'block';
            }
        }
        
        function downloadData(format) {
            const link = document.createElement('a');
            link.href = `/download/${format}`;
            link.download = `netease_music_data.${format}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus(`正在下载 ${format.toUpperCase()} 文件...`, 'info');
        }
    </script>
</body>
</html>
