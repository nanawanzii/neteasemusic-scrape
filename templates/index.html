<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘æ˜“äº‘éŸ³ä¹æ•°æ®çˆ¬è™«</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .container { max-width: 1200px; }
        .data-table { max-height: 500px; overflow-y: auto; }
        .stats-card { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .loading { display: none; text-align: center; margin: 20px; }
        .token-section { background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .data-section { display: none; }
        .chart-container { 
            background: white; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .charts-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); 
            gap: 20px; 
            margin: 20px 0; 
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">ğŸµ ç½‘æ˜“äº‘éŸ³ä¹æ•°æ®çˆ¬è™«</h1>
        
        <!-- Tokené…ç½®åŒºåŸŸ -->
        <div class="token-section">
            <h3>ğŸ”‘ é…ç½®è®¿é—®å‡­è¯</h3>
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">CSRF Token:</label>
                    <input type="text" id="csrf_token" class="form-control" placeholder="è¾“å…¥æœ€æ–°çš„csrf_token">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Cookie:</label>
                    <textarea id="cookie" class="form-control" rows="3" placeholder="è¾“å…¥å®Œæ•´çš„cookie"></textarea>
                </div>
            </div>
            <div class="mt-3">
                <button class="btn btn-primary" onclick="updateToken()">æ›´æ–°Token</button>
                <button class="btn btn-success ms-2" onclick="fetchData()">è·å–æ•°æ®</button>
            </div>
        </div>
        
        <!-- çŠ¶æ€æ˜¾ç¤º -->
        <div id="status" class="alert" style="display: none;"></div>
        
        <!-- åŠ è½½åŠ¨ç”» -->
        <div class="loading" id="loading">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2">æ­£åœ¨å¤„ç†...</p>
        </div>
        
        <!-- æ•°æ®å±•ç¤ºåŒºåŸŸ -->
        <div class="data-section" id="dataSection">
            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats-card">
                <h4>ğŸ“Š æ•°æ®ç»Ÿè®¡</h4>
                <div id="statsInfo"></div>
            </div>
            
            <!-- ä¸‹è½½é€‰é¡¹ -->
            <div class="text-center mb-4">
                <h4>ğŸ“¥ ä¸‹è½½æ•°æ®</h4>
                <button class="btn btn-success me-2" onclick="downloadData('excel')">ä¸‹è½½ Excel</button>
                <button class="btn btn-primary me-2" onclick="downloadData('csv')">ä¸‹è½½ CSV</button>
                <button class="btn btn-warning" onclick="downloadData('json')">ä¸‹è½½ JSON</button>
            </div>
            
            <!-- å¯è§†åŒ–å›¾è¡¨ -->
            <div id="chartsSection" style="display: none;">
                <h4>ğŸ“Š æ•°æ®å¯è§†åŒ–</h4>
                <div class="charts-grid" id="chartsContainer"></div>
            </div>
            
            <!-- æ•°æ®é¢„è§ˆ -->
            <div>
                <h4>ğŸ“‹ æ•°æ®é¢„è§ˆ</h4>
                <div class="data-table">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr id="tableHeader"></tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `alert alert-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
        
        function showLoading(show = true) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        async function updateToken() {
            const csrf_token = document.getElementById('csrf_token').value.trim();
            const cookie = document.getElementById('cookie').value.trim();
            
            if (!csrf_token || !cookie) {
                showStatus('è¯·å¡«å†™å®Œæ•´çš„Tokenå’ŒCookieä¿¡æ¯', 'warning');
                return;
            }
            
            showLoading(true);
            
            try {
                const response = await fetch('/update_token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ csrf_token, cookie })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus(result.message, 'success');
                } else {
                    showStatus(result.message, 'danger');
                }
                
            } catch (error) {
                showStatus('æ›´æ–°Tokenæ—¶å‡ºé”™: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        async function fetchData() {
            showLoading(true);
            
            try {
                const response = await fetch('/fetch_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus(result.message, 'success');
                    displayData(result.data, result.stats);
                    if (result.charts) {
                        displayCharts(result.charts);
                    }
                    document.getElementById('dataSection').style.display = 'block';
                } else {
                    showStatus(result.message, 'danger');
                }
                
            } catch (error) {
                showStatus('è·å–æ•°æ®æ—¶å‡ºé”™: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        function displayData(data, stats) {
            // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            const statsDiv = document.getElementById('statsInfo');
            statsDiv.innerHTML = `
                <p><strong>æ­Œæ›²æ€»æ•°:</strong> ${stats.total_songs}</p>
                <p><strong>æ•°æ®åˆ—:</strong> ${stats.columns.join(', ')}</p>
            `;
            
            // æ˜¾ç¤ºæ•°æ®è¡¨æ ¼
            if (data && data.length > 0) {
                const headerRow = document.getElementById('tableHeader');
                const tableBody = document.getElementById('tableBody');
                
                // æ¸…ç©ºç°æœ‰å†…å®¹
                headerRow.innerHTML = '';
                tableBody.innerHTML = '';
                
                // åˆ›å»ºè¡¨å¤´
                const headers = Object.keys(data[0]);
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                
                // åˆ›å»ºè¡¨æ ¼è¡Œ
                data.forEach(row => {
                    const tr = document.createElement('tr');
                    headers.forEach(header => {
                        const td = document.createElement('td');
                        td.textContent = row[header] || '';
                        tr.appendChild(td);
                    });
                    tableBody.appendChild(tr);
                });
            }
        }
        
        function displayCharts(charts) {
            const container = document.getElementById('chartsContainer');
            container.innerHTML = '';
            
            const chartTitles = {
                'top_songs': 'ğŸµ çƒ­é—¨æ­Œæ›²æ’è¡Œ',
                'numeric_comparison': 'ğŸ“Š æ•°å€¼å­—æ®µåˆ†å¸ƒå¯¹æ¯”',
                'scatter_plot': 'ğŸ”— å…³ç³»å›¾',
                'pie_chart': 'ğŸ“ˆ åˆ†å¸ƒé¥¼å›¾',
                'avg_comparison': 'ğŸ“ˆ å¹³å‡å€¼å¯¹æ¯”'
            };
            
            let hasCharts = false;
            
            Object.keys(charts).forEach(chartKey => {
                if (charts[chartKey]) {
                    hasCharts = true;
                    const chartDiv = document.createElement('div');
                    chartDiv.className = 'chart-container';
                    
                    const chartId = `chart_${chartKey}`;
                    chartDiv.innerHTML = `
                        <h5>${chartTitles[chartKey] || chartKey}</h5>
                        <div id="${chartId}"></div>
                    `;
                    
                    container.appendChild(chartDiv);
                    
                    try {
                        const plotData = JSON.parse(charts[chartKey]);
                        Plotly.newPlot(chartId, plotData.data, plotData.layout, {
                            responsive: true,
                            displayModeBar: true
                        });
                    } catch (e) {
                        console.error('æ¸²æŸ“å›¾è¡¨æ—¶å‡ºé”™:', e);
                        chartDiv.innerHTML = `<p class="text-danger">å›¾è¡¨æ¸²æŸ“å¤±è´¥: ${e.message}</p>`;
                    }
                }
            });
            
            if (hasCharts) {
                document.getElementById('chartsSection').style.display = 'block';
            }
        }
        
        function downloadData(format) {
            const link = document.createElement('a');
            link.href = `/download/${format}`;
            link.download = `netease_music_data.${format}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus(`æ­£åœ¨ä¸‹è½½ ${format.toUpperCase()} æ–‡ä»¶...`, 'info');
        }
    </script>
</body>
</html>
